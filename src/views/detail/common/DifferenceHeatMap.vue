<template>
  <div id="difference_heat_map">
    <BaseLoading ref="loading">
      <LeftRight :left-width="35">
        <template #left>
          <BaseSelect title="Top count:" is-line width="41%" :change-event="topCountGraphChange" :select-data="topCountData" ref="topCountGraph" :description="topDescription"/>
        </template>
        <template #right>
          <BaseSelect title="Log<sub>2</sub>(Fold change):" :is-line="true" width="55%" :change-event="cellTypeGraphChange" :select-data="Log2FoldChangeSelectData" ref="log2FoldChange"/>
        </template>
      </LeftRight>
      <div class="textarea">
        <div class="title">
          <span>Add {{ element === 'gene' ? 'gene' : 'TF' }}s: </span>
          <el-button @click="exampleClick" v-if="element === 'gene'"> Example</el-button>
          <el-button @click="addGenesClick"> Plot</el-button>
          <span class="heatmap_value" v-show="element === 'tf'">
            Value: `-Log10(P-value)` score.
          </span>
          <BaseSelect title="Value: "
                      is-line width="41%"
                      :change-event="valueLabelChange"
                      :select-data="[{ label: 'Score', value: 'score', default: true }, { label: 'Log2(Fold change)', value: 'log2_fold_change' }]"
                      ref="valueLabel" v-show="element === 'gene'"/>
        </div>
        <BaseInput type="textarea" :rows="2" :placeholder="placeholder" ref="geneTextarea"/>
      </div>
      <br/>
      <div ref="heatMap" v-show="isShow">
        <canvas :id="heatMapId" width="600" height="600"/>
      </div>
      <div class="heatmap_value" v-show="!isShow">There is no differential gene data, and the data can be obtained by reducing the screening criteria.</div>
    </BaseLoading>
  </div>
</template>

<script lang="ts">
import { defineComponent, onMounted, reactive, ref, toRefs, watch } from 'vue';
import '@/plugins/canvasxpress';
import '@/assets/less/views/Detail.less';
import StringUtil from '@/service/util/base/string';
import BaseLoading from '@/components/loading/BaseLoading.vue';
import Base from '@/service/util/base/base';
import DetailApi from '@/api/service/detailApi';
import BaseSelect from '@/components/input/BaseSelect.vue';
import { ANALYSIS_LOG2_FOLD_CHANGE_SELECT_DATA, DETAIL_ELEMENT_HEAT_MAP_TOP_COUNT_DATA } from '@/assets/ts';
import { ElNotification } from 'element-plus';
import LeftRight from '@/components/layout/LeftRight.vue';
import BaseInput from '@/components/input/BaseInput.vue';

export default defineComponent({
  name: 'DifferenceHeatMap',
  components: { BaseInput, LeftRight, BaseSelect, BaseLoading },
  props: {
    sampleId: {
      type: String,
      default: () => ''
    },
    element: {
      type: String,
      default: () => 'gene'
    },
    metadata: {
      type: String,
      default: () => 'cell_type'
    },
    topDescription: {
      type: String,
      default: () => 'Top count'
    }
  },
  setup(props) {
    const loading = ref();
    const heatMap = ref();
    const topCountGraph = ref();
    const log2FoldChange = ref();
    const valueLabel = ref();
    const geneTextarea = ref();
    const data = reactive({
      heatMapId: StringUtil.randomString(10),
      placeholder: `Please input the ${props.element}s  e.g. RCC2,APOE,LPP`,
      isShow: true
    });
    // Plot the heatmap
    const plotHeatMap = (dataInfo: any) => {
      // Need to re-add first
      heatMap.value.innerHTML = `<canvas id="${data.heatMapId}" width="600" height="700"></canvas>`;
      // @ts-ignore CanvasXpress causes errors in TypeScript, ignore all errors in the next line
      // eslint-disable-next-line no-undef,no-new
      new CanvasXpress(data.heatMapId, {
        x: {
          traits: dataInfo.ylabelList
        },
        y: {
          data: dataInfo.data,
          vars: dataInfo.xlabelList,
          smps: dataInfo.ylabelList
        }
      }, props.element === 'gene' ? {
        graphType: 'Heatmap',
        heatmapCellBoxColor: 'rgb(255,255,255)',
        samplesClustered: 'true',
        variablesClustered: 'true',
        showTransition: 'false',
        showHeatmapIndicator: 'false',
        showLegend: 'true',
        showSmpDendrogram: 'false',
        showVarDendrogram: 'false'
      } : {
        colorSpectrum: [
          'white',
          '#fe5916'
        ],
        graphType: 'Heatmap',
        heatmapCellBoxColor: 'rgb(255,255,255)',
        samplesClustered: 'true',
        variablesClustered: 'true',
        showTransition: 'false',
        showHeatmapIndicator: 'false',
        showLegend: 'true',
        showSmpDendrogram: 'false',
        showVarDendrogram: 'false'
      });
    };
    const getDifferenceHeatmap = () => {
      if (loading.value) {
        loading.value.loading = true;
        DetailApi.getDifferenceHeatmapBySampleId(props.element, {
          sampleId: props.sampleId,
          metadata: props.metadata,
          topCount: topCountGraph.value.select,
          log2FoldChange: log2FoldChange.value.select,
          names: geneTextarea.value.input,
          valueType: valueLabel.value.select
        }).then((res: any) => {
          loading.value.loading = false;
          if (Base.isNull(res.data)) {
            data.isShow = false;
          } else {
            data.isShow = true;
            plotHeatMap(res);
          }
        });
      }
    };

    const topCountGraphChange = () => {
      if (topCountGraph.value.select >= 2000) {
        ElNotification({ title: 'Tips', message: 'Too many quantity selections may cause slow loading, please be patient and wait!', type: 'info' });
      }
      getDifferenceHeatmap();
    };

    const cellTypeGraphChange = () => {
      getDifferenceHeatmap();
    };

    const valueLabelChange = () => {
      getDifferenceHeatmap();
    };

    const addGenesClick = () => {
      getDifferenceHeatmap();
    };

    const exampleClick = () => {
      if (props.element === 'gene') {
        geneTextarea.value.input = 'GLI1,GLI2,GLI3,GLI4,ASIP,SLC45A2,OCA2,PADI6,RCC2,CASC15,LINC00111,ZBTB10,LY6E,IL6,CALCA,FKBPL,HIF1A';
      }
    };

    onMounted(() => {
      topCountGraph.value.select = props.element === 'gene' ? 100 : 20;
      log2FoldChange.value.select = 0.6;
      data.placeholder = props.element === 'gene' ? 'Please input the genes  e.g. RCC2,APOE,LPP' : 'Please input the TFs  e.g. SPI1,GLI1,GLI2';

      if (Base.noNull(props.sampleId) && Base.noNull(props.metadata)) {
        getDifferenceHeatmap();
      }
    });

    // Monitor the sampleId and metadata properties
    watch(() => ({ value1: props.sampleId, value2: props.metadata }), () => {
      if (Base.noNull(props.sampleId) && Base.noNull(props.metadata)) {
        getDifferenceHeatmap();
      }
    }, {
      immediate: true,
      deep: true
    });
    return {
      ...toRefs(data),
      loading,
      heatMap,
      topCountGraph,
      log2FoldChange,
      valueLabel,
      geneTextarea,
      topCountGraphChange,
      cellTypeGraphChange,
      valueLabelChange,
      addGenesClick,
      exampleClick,
      topCountData: DETAIL_ELEMENT_HEAT_MAP_TOP_COUNT_DATA,
      Log2FoldChangeSelectData: ANALYSIS_LOG2_FOLD_CHANGE_SELECT_DATA
    };
  }
});
</script>
